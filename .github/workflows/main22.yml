name: Deploy SSIS Project

on:
  workflow_dispatch:

jobs:
  deploy-ssis-project:
    runs-on: [self-hosted, windows]

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy SSIS Project (.ispac)
        env:
          SQL_SERVER: ${{ secrets.SQL_SERVER }}

        run: |
          echo "Deploying SSIS project..."

          # Adjust this path to match your actual .ispac location
          $ispacPath = "Timesheet\SSIS_Packages\bin\Development\AutomatedTimesheet.ispac"

          # Confirm that the file exists
          if (!(Test-Path $ispacPath)) {
            Write-Error "ISPAC file not found at $ispacPath"
            exit 1
          }

          # Run the deployment wizard silently
          & "C:\Program Files (x86)\Microsoft SQL Server\160\DTS\Binn\ISDeploymentWizard.exe" `
            /Silent `
            /SourcePath:"$ispacPath" `
            /DestinationServer:"$env:SQL_SERVER" `
            /DestinationPath:"SSISDB\MyPackageDemos\TimeSheet"

          echo "SSIS project deployed successfully."
